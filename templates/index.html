<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Production Forecast</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div id="map"></div>

    <div class="main-title">
        <h1>Dairy AI Forecast</h1>
    </div>

    <div class="controls-container">
        <h3>Forecasting Controls</h3>
        <p>1. Click a highlighted green state on the map.</p>
        <p>2. Select a forecast period.</p>
        
        <div id="milk-type-container" class="hidden">
            <p>3. Select a milk type:</p>
            <div id="milk-type-options" class="milk-type-selector">
                </div>
        </div>
        <hr>
        <label for="weeks-slider">Weeks in Advance: <b id="weeks-label">1</b></label>
        <input type="range" id="weeks-slider" min="1" max="8" value="1">
        <p class="date-display" id="date-display">Predicting for week of: September 23, 2025</p>
        <button id="generate-button" disabled>Select a State First</button>
        <div id="progress-container" class="progress-container">
            <div class="progress-bar"></div>
        </div>
    </div>

    <div id="report-panel" class="report-panel">
        <h3 id="report-title">Forecast Report</h3>
        <div id="report-content">
            <div class="report-item">
                <h4>Est. Milk Volume</h4>
                <p id="report-estimate">---</p>
            </div>
            <div class="report-item">
                <h4>Est. Fat Percentage</h4>
                <p id="report-fat-percentage">---</p>
            </div>
            <div class="report-item">
                <h4>AI Analyst Reasoning</h4>
                <p id="report-reasoning">---</p>
            </div>
        </div>
    </div>

<script>
    // --- State & Variable Setup ---
    const targetStateNames = new Set(['California', 'Colorado', 'Iowa', 'Idaho', 'Illinois', 'Indiana', 'Kentucky', 'Maryland', 'Maine', 'Michigan', 'Minnesota', 'Missouri', 'North Carolina', 'New Hampshire', 'New Jersey', 'New York', 'Ohio', 'Oregon', 'Pennsylvania', 'South Dakota', 'Utah', 'Virginia', 'Vermont', 'Washington', 'Wisconsin', 'West Virginia']);
    const stateToMilkTypes = {
        'California': ['Validus', 'Organic'], 'Colorado': ['Validus'], 'Idaho': ['Validus', 'Organic'],
        'Indiana': ['Validus', 'Grass Fed', 'Organic'], 'Minnesota': ['Validus', 'Grass Fed', 'Organic'],
        'New Jersey': ['Validus', 'Grass Fed', 'Organic'], 'Ohio': ['Validus', 'Grass Fed', 'Organic'],
        'Oregon': ['Validus', 'Grass Fed', 'Organic'], 'Utah': ['Validus', 'Grass Fed', 'Organic'],
        'Virginia': ['Validus', 'Grass Fed'], 'Washington': ['Validus', 'Organic'], 'Wisconsin': ['Validus', 'Grass Fed', 'Organic'],
        'Iowa': ['Grass Fed', 'Organic'], 'Maryland': ['Grass Fed', 'Organic'], 'Michigan': ['Grass Fed', 'Organic'],
        'New York': ['Grass Fed', 'Organic'], 'Pennsylvania': ['Grass Fed', 'Organic'], 'Vermont': ['Grass Fed', 'Organic'],
        'Illinois': ['Organic'], 'Kentucky': ['Organic'], 'Maine': ['Organic'], 'Missouri': ['Organic'],
        'North Carolina': ['Organic'], 'New Hampshire': ['Organic'], 'South Dakota': ['Organic'], 'West Virginia': ['Organic']
    };
    let selectedStateLayer = null;
    let selectedStateName = null;
    let selectedWeeks = 1;
    let selectedMilkType = null;

    // --- DOM Element References ---
    const weeksSlider = document.getElementById('weeks-slider');
    const weeksLabel = document.getElementById('weeks-label');
    const dateDisplay = document.getElementById('date-display');
    const generateButton = document.getElementById('generate-button');
    const progressContainer = document.getElementById('progress-container');
    const reportPanel = document.getElementById('report-panel');
    const reportEstimate = document.getElementById('report-estimate');
    const reportFatPercentage = document.getElementById('report-fat-percentage');
    const reportReasoning = document.getElementById('report-reasoning');
    const reportTitle = document.getElementById('report-title');
    const milkTypeContainer = document.getElementById('milk-type-container');
    const milkTypeOptionsDiv = document.getElementById('milk-type-options');

    // --- Map Initialization ---
    const map = L.map('map', { 
        zoomControl: false, 
        scrollWheelZoom: false, 
        doubleClickZoom: false,
        dragging: false
    }).setView([39.82, -98.58], 4);

    // --- State Styling Functions ---
    const defaultStyle = { color: "#800000", weight: 1, opacity: 0.6, fillColor: '#ff4d4d', fillOpacity: 0.2 };
    const targetStyle = { color: "#006400", weight: 1, opacity: 0.6, fillColor: '#28a745', fillOpacity: 0.3 };
    const hoverStyle = { weight: 3, color: '#e5a00d', fillOpacity: 0.7 };
    const selectedStyle = { weight: 3, color: '#4a72e8', fillColor: '#4a72e8', fillOpacity: 0.8 }; // CHANGED to dark blue

    // --- Load GeoJSON Data ---
    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
        .then(res => res.json())
        .then(geojson => {
            geojson.features = geojson.features.filter(f => f.properties.name !== 'Alaska' && f.properties.name !== 'Hawaii' && f.properties.name !== 'Puerto Rico');
            L.geoJson(geojson, {
                style: f => targetStateNames.has(f.properties.name) ? targetStyle : defaultStyle,
                onEachFeature: (feature, layer) => {
                    if (targetStateNames.has(feature.properties.name)) {
                        layer.on({
                            mouseover: e => { if (layer !== selectedStateLayer) layer.setStyle(hoverStyle); },
                            mouseout: e => { if (layer !== selectedStateLayer) layer.setStyle(targetStyle); },
                            click: e => handleStateClick(feature, layer)
                        });
                    }
                }
            }).addTo(map);
        });

    // --- Event Handler Functions ---
    function handleStateClick(feature, layer) {
        if (selectedStateLayer) selectedStateLayer.setStyle(targetStyle);
        layer.setStyle(selectedStyle);
        selectedStateLayer = layer;
        selectedStateName = feature.properties.name;
        
        updateMilkTypeSelector(selectedStateName);

        generateButton.disabled = false;
        generateButton.textContent = `Generate Report for ${selectedStateName}`;
        reportPanel.classList.remove('visible');
    }

    function updateMilkTypeSelector(stateName) {
        const availableTypes = stateToMilkTypes[stateName] || [];
        milkTypeOptionsDiv.innerHTML = ''; 

        if (availableTypes.length > 0) {
            availableTypes.forEach((type, index) => {
                const id = `type-${type.replace(/\s+/g, '-')}`;
                const option = document.createElement('div');
                option.innerHTML = `
                    <input type="radio" id="${id}" name="milk-type" value="${type}" ${index === 0 ? 'checked' : ''}>
                    <label for="${id}">${type}</label>
                `;
                milkTypeOptionsDiv.appendChild(option);
            });
            
            selectedMilkType = availableTypes[0];
            
            milkTypeOptionsDiv.querySelectorAll('input[name="milk-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedMilkType = e.target.value;
                });
            });

            milkTypeContainer.classList.remove('hidden');
        } else {
            milkTypeContainer.classList.add('hidden');
            selectedMilkType = null;
        }
    }

    function updateDateDisplay(weeks) {
        const days = parseInt(weeks) * 7;
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + days);
        dateDisplay.textContent = `Predicting for week of: ${futureDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
    }

    weeksSlider.addEventListener('input', e => {
        selectedWeeks = e.target.value;
        weeksLabel.textContent = selectedWeeks;
        updateDateDisplay(selectedWeeks);
    });

    generateButton.addEventListener('click', () => {
        if (!selectedStateName || !selectedMilkType) return;

        progressContainer.style.display = 'block';
        reportPanel.classList.remove('visible');
        generateButton.disabled = true;
        generateButton.textContent = 'Generating...';

        const daysInAdvance = selectedWeeks * 7;
        const apiUrl = `/predict?state=${selectedStateName}&days=${daysInAdvance}&milk_type=${encodeURIComponent(selectedMilkType)}`;
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => displayReport(data))
            .catch(error => {
                console.error('Error fetching report:', error);
                reportReasoning.textContent = "An error occurred fetching the prediction. Please try again.";
            })
            .finally(() => {
                progressContainer.style.display = 'none';
                generateButton.disabled = false;
                generateButton.textContent = `Generate Report for ${selectedStateName}`;
            });
    });
    
    function displayReport(data) {
        reportTitle.textContent = `Forecast for ${selectedStateName}`;
        reportEstimate.textContent = data.estimate;
        reportFatPercentage.textContent = data.fat_percentage;
        reportReasoning.textContent = data.reasoning;
        reportPanel.classList.add('visible');
    }

    updateDateDisplay(selectedWeeks);

</script>
</body>
</html>